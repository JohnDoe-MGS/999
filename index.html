<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dissecador Forense de PDF | Compliance</title>
    
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff;
            --border-color: #30363d;
            --success-color: #238636;
            --warning-color: #d29922;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .input-section {
            background-color: #161b22;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 200px;
            background-color: #0d1117;
            color: #79c0ff;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            resize: vertical;
        }

        button {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.9;
        }

        #output {
            background-color: #161b22;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            white-space: pre-wrap; /* Mant√©m a formata√ß√£o do Python */
            min-height: 100px;
        }

        .loading {
            color: var(--warning-color);
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üïµÔ∏è Dissecador Forense de PDF</h1>
    <p>Ferramenta de an√°lise de integridade, UUIDs e metadados para Compliance.</p>

    <div class="input-section">
        <label for="pdf_content">Cole o C√≥digo Bruto do PDF aqui (Texto):</label>
        <textarea id="pdf_content" placeholder="Cole o conte√∫do do arquivo .txt ou PDF aqui (come√ßando com %PDF-1.7...)"></textarea>
        <button id="analyze-btn" py-click="analisar_codigo">Executar An√°lise Forense</button>
        <p id="loading-msg" class="loading">Processando dados forenses...</p>
    </div>

    <h3>Relat√≥rio de An√°lise:</h3>
    <div id="output">O relat√≥rio aparecer√° aqui ap√≥s a an√°lise...</div>
</div>

<py-script>
import re
import uuid
import struct
from datetime import datetime

def formatar_data_pdf(raw_date):
    # Formata datas do tipo D:20251013...
    try:
        limpo = raw_date.replace("D:", "").replace("'", "")
        data_parte = limpo[:14]
        fuso_sinal = limpo[14] if len(limpo) > 14 else "+"
        fuso_horas = limpo[15:17] if len(limpo) > 16 else "00"
        
        # Formata√ß√£o visual
        ano = data_parte[0:4]
        mes = data_parte[4:6]
        dia = data_parte[6:8]
        hora = data_parte[8:10]
        min = data_parte[10:12]
        
        return f"{dia}/{mes}/{ano} √†s {hora}:{min} (UTC {fuso_sinal}{fuso_horas}:00)"
    except:
        return raw_date

def analisar_codigo(*args):
    # Pega o conte√∫do da caixa de texto do HTML
    conteudo = Element("pdf_content").element.value
    
    if not conteudo:
        Element("output").write("Erro: A caixa de texto est√° vazia. Cole o c√≥digo do PDF primeiro.")
        return

    relatorio = []
    relatorio.append("--- RELAT√ìRIO T√âCNICO DE COMPLIANCE ---\n")

    # 1. An√°lise de Identidade e Software
    autor = re.search(r'/Author\((.*?)\)', conteudo)
    criador = re.search(r'/Creator\((.*?)\)', conteudo)
    
    autor_str = autor.group(1).replace('\x00', '') if autor else "Desconhecido"
    criador_str = criador.group(1).replace('\x00', '') if criador else "Desconhecido"
    
    relatorio.append(f"[1] IDENTIDADE DECLARADA")
    relatorio.append(f"    Autor:    {autor_str}")
    relatorio.append(f"    Software: {criador_str}")

    # 2. Data e Fuso Hor√°rio
    data_criacao = re.search(r'/CreationDate\((.*?)\)', conteudo)
    if data_criacao:
        relatorio.append(f"\n[2] CRONOLOGIA E LOCALIZA√á√ÉO TEMPORAL")
        relatorio.append(f"    Data Real: {formatar_data_pdf(data_criacao.group(1))}")
        if "-03'00" in data_criacao.group(1):
             relatorio.append("    An√°lise de Fuso: UTC -03:00 confirmada (Compat√≠vel com Brasil).")

    # 3. An√°lise de IDs (Integridade)
    doc_id_match = re.search(r'xmpMM:DocumentID>uuid:(.*?)</xmpMM:DocumentID', conteudo)
    inst_id_match = re.search(r'xmpMM:InstanceID>uuid:(.*?)</xmpMM:InstanceID', conteudo)
    
    relatorio.append(f"\n[3] INTEGRIDADE E UUIDs")
    if doc_id_match and inst_id_match:
        doc_id = doc_id_match.group(1)
        inst_id = inst_id_match.group(1)
        
        relatorio.append(f"    Document ID: {doc_id}")
        relatorio.append(f"    Instance ID: {inst_id}")
        
        if doc_id == inst_id:
            relatorio.append("    VEREDITO: ‚úÖ ARQUIVO ORIGINAL (N√£o editado ap√≥s exporta√ß√£o)")
        else:
            relatorio.append("    VEREDITO: ‚ö†Ô∏è ARQUIVO MODIFICADO OU DERIVADO")

        # Vers√£o do UUID
        try:
            versao = uuid.UUID(doc_id).version
            relatorio.append(f"    Tipo de UUID: v{versao} (Pseudo-Aleat√≥rio/Privacidade)")
            if versao == 4:
                relatorio.append("    Nota: UUID v4 n√£o cont√©m IP nem MAC Address (Padr√£o Microsoft moderno).")
        except:
            pass
    else:
        relatorio.append("    N√£o foram encontrados metadados XMP suficientes para valida√ß√£o cruzada.")

    # 4. An√°lise de Links (V√≠nculo Corporativo)
    links = re.findall(r'/URI\((http.*?)\)', conteudo)
    if links:
        relatorio.append(f"\n[4] V√çNCULOS EXTERNOS ENCONTRADOS")
        for link in links:
            relatorio.append(f"    -> {link}")
            if "souzafreitas" in link:
                relatorio.append("    [!] V√≠nculo com dom√≠nio 'souzafreitas.com.br' detectado.")

    # 5. Valida√ß√£o de Assinatura Windows (Endianness)
    trailer_id = re.search(r'/ID\[<(.*?)>', conteudo)
    if doc_id_match and trailer_id:
        uuid_str = doc_id_match.group(1)
        hex_trailer = trailer_id.group(1)
        
        # Simula a invers√£o de bytes da Microsoft
        try:
            u = uuid.UUID(uuid_str)
            bytes_ms = struct.pack('<IHH', u.time_low, u.time_mid, u.time_hi_version) + u.bytes[8:]
            hex_ms = bytes_ms.hex().upper()
            
            if hex_ms == hex_trailer:
                relatorio.append(f"\n[5] ASSINATURA T√âCNICA DO SISTEMA")
                relatorio.append("    ‚úÖ Padr√£o 'Little Endian' detectado.")
                relatorio.append("    Confirma√ß√£o: Arquivo gerado em ambiente Microsoft Windows nativo.")
        except:
            pass

    # Imprime tudo na div de output
    Element("output").write("\n".join(relatorio))

</py-script>

</body>
</html>
