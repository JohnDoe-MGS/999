<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dissecador Forense de PDF | Compliance</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        :root { --bg-color: #0d1117; --text-color: #c9d1d9; --accent-color: #58a6ff; --border-color: #30363d; --success-color: #238636; }
        body { font-family: 'Courier New', Courier, monospace; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .input-section { background-color: #161b22; padding: 20px; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; font-weight: bold; }
        textarea { width: 100%; height: 200px; background-color: #0d1117; color: #79c0ff; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; font-family: monospace; resize: vertical; }
        button { background-color: var(--success-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px; font-family: 'Courier New', monospace; font-weight: bold; }
        button:hover { opacity: 0.9; }
        #output { background-color: #161b22; padding: 20px; border-radius: 6px; border: 1px solid var(--border-color); white-space: pre-wrap; min-height: 100px; margin-top: 20px; border-left: 5px solid var(--accent-color);}
        .loading { color: #d29922; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üïµÔ∏è Dissecador Forense de PDF</h1>
    <p>Ferramenta de an√°lise de integridade, UUIDs e metadados para Compliance.</p>

    <div class="input-section">
        <label for="pdf_content">Cole o C√≥digo Bruto do PDF aqui (Texto):</label>
        <textarea id="pdf_content" placeholder="Cole o conte√∫do do arquivo .txt ou PDF aqui (come√ßando com %PDF-1.7...)"></textarea>
        
        <button id="analyze-btn">Executar An√°lise Forense</button>
        <div id="status_msg" class="loading">Sistema pronto. Cole o c√≥digo e clique no bot√£o.</div>
    </div>

    <h3>Relat√≥rio de An√°lise:</h3>
    <div id="output">Aguardando dados...</div>
</div>

<script type="py">
from pyscript import when
from js import document
import re
import uuid
import struct

def formatar_data_pdf(raw_date):
    try:
        limpo = raw_date.replace("D:", "").replace("'", "")
        data_parte = limpo[:14]
        ano = data_parte[0:4]
        mes = data_parte[4:6]
        dia = data_parte[6:8]
        hora = data_parte[8:10]
        minuto = data_parte[10:12]
        return f"{dia}/{mes}/{ano} √†s {hora}:{minuto}"
    except:
        return raw_date

@when("click", "#analyze-btn")
def processar_analise(event):
    # Pega os elementos da tela via Javascript Bridge
    input_box = document.getElementById("pdf_content")
    output_box = document.getElementById("output")
    
    conteudo = input_box.value

    if not conteudo:
        output_box.innerText = "ERRO: A caixa de texto est√° vazia."
        return

    output_box.innerText = "Processando..."
    relatorio = []
    
    try:
        relatorio.append("--- RELAT√ìRIO T√âCNICO DE COMPLIANCE ---\n")

        # 1. IDENTIDADE
        autor = re.search(r'/Author\((.*?)\)', conteudo)
        criador = re.search(r'/Creator\((.*?)\)', conteudo)
        
        relatorio.append("[1] IDENTIDADE DECLARADA")
        if autor:
            clean_autor = autor.group(1).replace('\x00', '')
            relatorio.append(f"    Autor:    {clean_autor}")
        else:
            relatorio.append("    Autor:    N√£o detectado")
            
        if criador:
            clean_criador = criador.group(1).replace('\x00', '')
            relatorio.append(f"    Software: {clean_criador}")

        # 2. DATA
        dt = re.search(r'/CreationDate\((.*?)\)', conteudo)
        if dt:
            relatorio.append("\n[2] CRONOLOGIA E LOCAL")
            data_raw = dt.group(1)
            relatorio.append(f"    Data: {formatar_data_pdf(data_raw)}")
            if "-03'00" in data_raw:
                relatorio.append("    Fuso: -03:00 (Compat√≠vel com Hor√°rio de Bras√≠lia)")

        # 3. UUIDS E INTEGRIDADE
        relatorio.append("\n[3] INTEGRIDADE E UUIDs")
        doc_id = re.search(r'xmpMM:DocumentID>uuid:(.*?)</xmpMM:DocumentID', conteudo)
        inst_id = re.search(r'xmpMM:InstanceID>uuid:(.*?)</xmpMM:InstanceID', conteudo)
        
        if doc_id and inst_id:
            d_id = doc_id.group(1)
            i_id = inst_id.group(1)
            
            relatorio.append(f"    Document ID: {d_id}")
            relatorio.append(f"    Instance ID: {i_id}")
            
            if d_id == i_id:
                relatorio.append("    VEREDITO: ‚úÖ ARQUIVO ORIGINAL (Sem re-salvamento)")
            else:
                relatorio.append("    VEREDITO: ‚ö†Ô∏è ARQUIVO MODIFICADO")
        else:
            relatorio.append("    Metadados XMP incompletos no c√≥digo colado.")

        # 4. VINCULOS
        links = re.findall(r'/URI\((http.*?)\)', conteudo)
        if links:
            relatorio.append("\n[4] V√çNCULOS ENCONTRADOS")
            for link in links:
                relatorio.append(f"    -> {link}")

        # 5. ASSINATURA WINDOWS
        trailer_id = re.search(r'/ID\[<(.*?)>', conteudo)
        if doc_id and trailer_id:
            try:
                # Checagem de Endianness
                u = uuid.UUID(doc_id.group(1))
                # Pack Little Endian para Microsoft
                bytes_ms = struct.pack('<IHH', u.time_low, u.time_mid, u.time_hi_version) + u.bytes[8:]
                hex_ms = bytes_ms.hex().upper()
                
                if hex_ms == trailer_id.group(1):
                    relatorio.append("\n[5] ASSINATURA T√âCNICA")
                    relatorio.append("    ‚úÖ Byte-order Little Endian confirmado.")
                    relatorio.append("    Origem: Gerado em Microsoft Windows.")
            except:
                pass

    except Exception as e:
        relatorio.append(f"\nERRO CR√çTICO DE LEITURA: {str(e)}")

    # Exibe o resultado
    output_box.innerText = "\n".join(relatorio)
</script>

</body>
</html>
